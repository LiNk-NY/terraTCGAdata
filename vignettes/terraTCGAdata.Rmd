---
title: "terraTCGAdata Introduction"
author: "Marcel Ramos"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Obtain Terra TCGA data as MultiAssayExperiment}
  %\VignetteEncoding{UTF-8}
output:
  BiocStyle::html_document:
    number_sections: yes
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

# Installation (development version)

```{r,eval=FALSE}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("LiNk-NY/terraTCGAdata")
```

# Description

Terra workspaces come pre-packaged with TCGA data. The challenge is to make
use of the Terra data model and represent the data as `MultiAssayExperiment`.

# Requirements

## Loading packages

```{r,include=TRUE,results="hide",message=FALSE,warning=FALSE}
library(AnVIL)
library(terraTCGAdata)
```

## gcloud sdk installation

A valid GCloud SDK installation is required to use the package. Use the
`gcloud_exists()` function to identify whether it is installed in your
system.

```{r}
gcloud_exists()
```

You can use the `gcloud_project` to set a project name:

```{r}
gcloud_project()
```

# Default Data Workspace

To get a list of available TCGA workspaces, use the `findTCGAworkspaces()`
function: 

```{r, eval=gcloud_exists()}
findTCGAworkspaces()
```

You can then set a package-wide option with the `terraTCGAworkspace` function
and check the setting with the ``.

```{r,eval=gcloud_exists()}
terraTCGAworkspace()
getOption("terraTCGAdata.workspace")
```

# Clinical data resources

```{r, eval=gcloud_exists()}
ct <- getClinicalTable(workspace = "TCGA_COAD_OpenAccess_V1-0_DATA")
ct
names(ct)
```

# Clinical data download

```{r, eval=gcloud_exists()}
column_name <- "clin__bio__nationwidechildrens_org__Level_1__biospecimen__clin"
clin <- getClinical(
    columnName = column_name,
    participants = TRUE,
    workspace = "TCGA_COAD_OpenAccess_V1-0_DATA"
)
clin[, 1:6]
dim(clin)
```

# Assay data resources

```{r, eval=gcloud_exists()}
at <- getAssayTable(workspace = "TCGA_COAD_OpenAccess_V1-0_DATA")
at
names(at)
```

# Intermediate function for obtaining only the data

```{r, eval=gcloud_exists()}
sampleTypesTable(workspace = "TCGA_COAD_OpenAccess_V1-0_DATA")
prot <- getAssayData(
    assayName = "protein_exp__mda_rppa_core__mdanderson_org__Level_3__protein_normalization__data",
    sampleCode = c("01", "10"),
    workspace = "TCGA_COAD_OpenAccess_V1-0_DATA",
    sampleIdx = 1:4
)
head(prot)
```

# MultiAssayExperiment

```{r, eval=gcloud_exists()}
mae <- terraTCGAdata(
    clinicalName = "clin__bio__nationwidechildrens_org__Level_1__biospecimen__clin",
    assays =
      c("protein_exp__mda_rppa_core__mdanderson_org__Level_3__protein_normalization__data",
      "rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data"),
    sampleCode = NULL,
    split = FALSE,
    sampleIdx = 1:4,
    workspace = "TCGA_COAD_OpenAccess_V1-0_DATA"
)
mae
```

